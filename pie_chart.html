<html>

<head>

    <!DOCTYPE html>
    <meta charset="utf-8">
    <title>Pie Chart</title>
    <style>
        .node circle {
            fill: #999;
        }
        
        .link {
            fill: none;
            stroke: #555;
            stroke-opacity: 0.4;
            stroke-width: 1.5px;
        }
    </style>
</head>



<body>
    <script src="http://d3js.org/d3.v4.min.js"></script>

    <script>
        var width = 960
        var height = 2000
        var root

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)


        var g = d3.select("svg")
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")


        var tree = d3.tree()
            .size([width / 4, height / 4])
            .separation(function(a, b) {
                return (a.parent == b.parent ? 1 : 2) / a.depth;
            })

        var stratify = d3.stratify()
            .parentId(function(d) {
                return d.id.substring(0, d.id.lastIndexOf("."))
            })

        function project(x, y) {
            var angle = (x - 90) / 90 * Math.PI
            var radius = y
            return [radius * Math.cos(angle), radius * Math.sin(angle)]
        }

        // function collapse(d) {
        //     if (d.children) {
        //         d._children = d.children
        //         console.log(d.children)
        //         d._children.forEach(collapse)
        //         d.children = null
        //     }
        // }

        function click(d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            render(d)
        }

        function render(source) {

            var link = g.selectAll(".link")
                .data(root.descendants().slice(1))
                .enter()
                .append("path")
                .attr("d", function(d) {
                    return "M" + project(d.x, d.y)
                        //  + "C" + project(d.x, (d.y + d.parent.y) / 2)
                        //  + " " + project(d.parent.x, (d.y + d.parent.y) / 2)
                        +
                        "L" + project(d.parent.x, d.parent.y);
                })
                .attr("class", "link")


            var nodes = root.descendants()
            nodes.forEach(function(d) {
                d.x0 = d.x
                d.y0 = d.y
            })


            // var links = nodes.forEach(function(d) {
            //     return d.links()
            // })

            var node = g.selectAll(".node")
                .data(nodes, function(d) {
                    return d.id
                })

            var nodeEnter = node.enter()


            var nodeExit = node.exit()

            var enterNode_ini = nodeEnter.append("g")
                .on("click", click)
                .attr("class", "node")
                .attr("transform", function(d) {
                    return "translate(" + project(source.x, source.y) + ")"
                })

            enterNode_ini.append("circle")
                .attr("r", 5)


            var entereNode = enterNode_ini.transition()
                .duration(750)
                .attr("transform", function(d) {
                    if (d) {
                        return "translate(" + project(d.x, d.y) + ")"
                    }
                })

            var exitNode = nodeExit.transition()
                .duration(750)
                .attr("transform", function(d) {
                    return "translate(" + project(source.x, source.y) + ")"
                })
                .remove()

            exitNode.select("circle")
                .attr("r", 0)

        }

        d3.csv("flare.csv", function(error, data) {
            if (error) throw error
            root = tree(stratify(data))
            render(root)

            // node.append("text")
            //     .attr("dy", "-20")
            //     .attr("x", function(d) { return d.x < 180 === !d.children ? 1 : -1 })
            //     .text(function(d) { return d.id.substring(d.id.lastIndexOf(".") + 1); })
            //     // .attr("transform", function(d) { return "rotate(" + (d.x < 180 ? d.x - 90 : d.x + 90) + ")"; })
        })
    </script>
</body>

</html>